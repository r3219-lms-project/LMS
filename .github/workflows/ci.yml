name: "ğŸš€ LMS Requirements Check"

on:
  push:
    branches: [ main, develop ]     # run on every commit to main/develop
  pull_request:
    branches: [ main ]              # and on PRs targeting main

# Cancel older runs for the same branch/PR if a new commit arrives
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  requirements-check:
    name: "âœ… All Requirements Verification"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: lms_password
          POSTGRES_USER: lms_user
          POSTGRES_DB: lmsdb
        options: >-
          --health-cmd "pg_isready -U lms_user -d lmsdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: lms_user
          MONGO_INITDB_ROOT_PASSWORD: lms_password
        options: >-
          --health-cmd "mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21 (Temurin) + Maven cache
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'              # built-in Maven cache

      # âœ… REQUIREMENTS 1â€“4: Tool versions
      - name: ğŸ” Check Tool Versions
        run: |
          echo "âœ… REQUIREMENT 1: Java version"
          java -version
          echo ""
          echo "âœ… REQUIREMENT 2: Maven version"
          mvn -version -U -ntp
          echo ""
          echo "âœ… REQUIREMENT 3: PostgreSQL version"
          sudo apt-get update -qq
          sudo apt-get install -y postgresql-client
          PGPASSWORD=lms_password psql -h localhost -U lms_user -d lmsdb -c "SELECT version();"
          echo ""
          echo "âœ… REQUIREMENT 4: MongoDB version"
          curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
          sudo apt-get update -qq
          sudo apt-get install -y mongodb-mongosh
          mongosh --host localhost:27017 --username lms_user --password lms_password --authenticationDatabase admin --eval "print('MongoDB version: ' + db.version())"

      # âœ… REQUIREMENT 5: Code style (non-blocking)
      - name: ğŸ¨ Code Style Check (Checkstyle)
        run: mvn -B -U -ntp checkstyle:check
        continue-on-error: true

        # âœ… REQUIREMENT 6: Static analysis (non-blocking)
      - name: ğŸ› Bug Detection (PMD)
        run: mvn -B -U -ntp compile pmd:check
        continue-on-error: true

      # âœ… REQUIREMENT 7: Run unit tests on each commit/PR
      - name: ğŸ§ª Run Tests
        run: mvn -B -U -ntp clean test

      # Upload test reports even if tests fail (helps debugging in PRs)
      - name: â¬†ï¸ Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**

      # âœ… REQUIREMENT 8: Build JAR (skip tests here because they ran already)
      - name: ğŸ“¦ Build JAR
        run: |
          mvn -B -U -ntp package -DskipTests
          echo "ğŸ“¦ Built JAR files (top 10):"
          find . -name "*.jar" -type f | head -10

      - name: âœ… Final Summary
        if: always()
        run: |
          echo "ğŸ¯ =========================================="
          echo "ğŸ¯       PIPELINE COMPLETED"
          echo "ğŸ¯ =========================================="
          echo "âœ… Java 21 - checked"
          echo "âœ… Maven - checked"
          echo "âœ… PostgreSQL 15 - service up"
          echo "âœ… MongoDB 7.0 - service up"
          echo "âœ… Checkstyle - executed (non-blocking)"
          echo "âœ… PMD - executed (non-blocking)"
          echo "âœ… Tests - executed"
          echo "âœ… JAR - built"
